# Обработка данных в Agisoft Metashape {#agisoft}


## Программное обеспечение {#agisoft-soft}
[В начало справки ⇡](#agisoft)


Agisoft Metashape – коммерческое фотограмметрическое ПО, использующее технологии компьютерного зрения. Домашний адрес со всей информацией о программе доступен по ссылке [](https://www.agisoft.com/){target="_blank"}, в том числе руководство пользователя на русском и английском языках.


## Исходные данные {#agisoft-initial}
[В начало справки ⇡](#agisoft)


В качестве исходных данных в этой справке приведены снимки, полученные с БПЛА DJI Phantom 4 и опорные точки, измеренные с помощью высокоточного ГНСС.


[Снимки](https://disk.yandex.ru/d/E8aQT6f8C_KBuw){target="_blank"}


[Наземные опорные точки](https://disk.yandex.ru/d/_5-zxp2QLPxKxQ){target="_blank"}


## Интерфейс {#agisoft-interface}
[В начало справки ⇡](#agisoft)

Интерфейс программы состоит из основного окна 3D-вьюера, окна **Workspace** слева, куда добавляются блоки (**Chunk**) фотографий (**Cameras**). Другие окна показывают фотографии блока, свойства слоёв, информацию о привязке, маркеры и другие. С полным перечнем окон и панелей можно ознакомиться, щёлкнув правой кнопкой мыши по пустому месту сверху – там можно включить или выключить окно/панель.


![Вид окна программы](images\Ref18\Interface.png)


Настройки программы доступны через меню **Tools – Preferences**. Убедитесь в том, что ресурсы видеокарты используются для вычислений.


![Включение GPU для ускорения вычислений](images\Ref18\Preferences.png)


Добавить фотографии можно, щёлкнув правой кнопкой по **Chunk** и вызвав меню **Add – Add Photos...** или **Add – Add Folder...**. Фотографии добавятся в окно блока и в окно с превью. Если в EXIF фотографий присутствуют геотеги, то соответствующие строчки появятся в окне **Reference**. При добавлении фотографий с БПЛА могут присутствовать углы ориентирования, как минимум рысканье (**Yaw**).


![Окно с координатами центров проекции фотографий](images\Ref18\Reference.png)


При наличии геотегов добавленных фотографий их центры проекций будут схематично показываться и подписывать в окне 3D-вьюера. Кнопка **Show Basemap** ![](images\Ref18\Basemap.png) включает и выключает подложку базовой карты, кнопка **Show Cameras** ![](images\Ref18\Cameras.png) включает и выключает показ центров проекций снимков.


Перемещать вид в окне 3D-вьюера можно зажатой левой кнопкой мыши, меняется масштаб с помощью колёсика мыши, поворачивается вид с помощью зажатого колёсика мыши.


Всё содержимое окна программы может быть сохранено в проект формата **PSX**.


## Взаимное ориентирование снимков {#agisoft-alignment}
[В начало справки ⇡](#agisoft)


Вызовите меню **Workflow – Align Photos**. В открывшемся окне будут доступны настройки:


**Accuracy** – точность, определяемая разрешением используемого уровня дискретизации. Значение **High** соответствует исходному разрешению снимков, каждый последующий уровень точности приводит к увеличению размера пикселя в 4 раза, соответственно время обработки данных с менее высокой точностью будет уменьшаться;


**Generic preselection** – использование изображений с худшим разрешением (пирамидальные слои) для предварительного отождествления соответственных точек на снимке;


**Reference preselection** – использование геотегов из EXIF фотографий для их предварительного ориентирования;


**Reset current alignment** – сброс текущих параметров ориентирования снимков;


**Key point limit** – лимит нахождения ключевых точек на снимке. Рекомендуется использовать значение *40 000*, а значение *0* означает отсутствие лимита;


**Tie point limit** – лимит нахождения связующих точек на снимке. Рекомендуется использовать значение *4 000*, а значение *0* означает отсутствие лимита;


**Adaptive camera model fitting** – при уравнивании связок проектирующих лучей происходит самокалибровка камеры.


![Настройки взаимного ориентирования (выравнивания)](images\Ref18\Align_Photos.png)


По завершении операции вы получаете облако связующих точек (**Tie Points**) или разреженное облако точек.


![Разреженное облако точек](images\Ref18\Sparse_Cloud.png)


Все обнаруженные отождествления ключевых точек для каждой пары снимков можно найти в меню **Tools – Tie Points – View Matches...**.


![Обнаруженные корректные и некорректные отождествления для пары снимков](images\Ref18\Matches.png)


Параметры калибровки камеры после взаимного ориентирования меняются. С ними можно ознакомиться через меню **Tools – Camera calibration...**.


![Параметры калибровки камеры](images\Ref18\Camera_Calibration.png)


## Расстановка опорных точек {#agisoft-markers}
[В начало справки ⇡](#agisoft)


Опорные точки можно расставить вручную, если правой кнопкой мыши щёлкнуть по облаку точек в нужном месте и из выпадающего меню выбрать **Add Marker**. Соответствующая строчка с маркером появится в окне **Reference**, а в окне **Photos** на фотографиях, куда попадает маркер, появится синий флаг. При установке проекции маркера на конкретной фотографии флаг станет зелёным.


![Ручная установка маркера](images\Ref18\Manual_Markers.png)


Если правой кнопкой мыши вызвать выпадающее меню в точке разреженного облака точек и выбрать пункт **Filter Photos by point**, перечень фотографий в окне **Photos** сократится. Для сброса фильтра нажмите на кнопку ![](images\Ref18\Reset_Filter.png) на панели окна **Photos**.


Если данные по опорным точкам сведены в текстовый файл с разделителем, его можно добавить, нажав на кнопку **Import Reference** ![](images\Ref18\Import_Reference.png). Откроется окно, где вам будет предложено установить символ разделителя, расставить в нужном порядке колонки и указать, с какой строчки необходимо начать считывать данные.


![Окно импорта CSV](images\Ref18\Import_CSV.png)


В окне **Reference** нажмите на **Settings** ![](images\Ref18\Settings.png), убедитесь в правильности установленных систем координат для модели, фотографий и маркеров (они могут быть разные). Установите точности для координат центров проекций и координат расставляемых маркеров.


Установите маркеры на фотографиях, где присутствуют опознаки. Для этого откройте одну из фотографий в окне **Photos**, в точке опознака щёлкните правой кнопкой мыши и выберите пункт **Place Marker** и выберите нужный маркер из имеющихся. После установке хотя бы двух проекций программа начнёт подсказывать, на каких фотографиях присутствуют маркеры с помощью символа серого флага ![](images\Ref18\Grey_Flag.png). Для хорошего результата необходимо, чтобы каждый маркер имел не менее четырёх проекций, а сами проекции не были установлены в области пониженной резкости изображения или совсем на краю снимка.


![Установка проекции маркера](images\Ref18\Place_Marker.png)


Нажмите на кнопку **Optimize** ![](images\Ref18\Optimize.png) для калибровки элементов внутреннего и внешнего ориентирования камеры, а также параметров дисторсии.


![Выбор параметров оптимизации камеры](images\Ref18\Optimize_Camera.png)


## Построение плотного облака точек {#agisoft-dense}
[В начало справки ⇡](#agisoft)


В главном меню вызовите **Workflow – Build Dense Cloud...**. После окончания работы инструмента в окне **Workspace** появятся слои карт глубины (**Depth Maps**) и плотное облако точек (**Dense Cloud**).


![Плотное облако точек](images\Ref18\Dense_Cloud.png)


## Построение ЦМП и фотомозаики {#agisoft-DEM}
[В начало справки ⇡](#agisoft)


Для построения цифровой модели поверхности на основе плотного облака точек в главном меню вызовите **Workflow – Build DEM...**. Для построения фотомозаики вам потребуется ЦМП, полученная на предыдущем этапе – в главном меню вызовите **Workflow – Build Orthomosaic...**.


![Цифровая модель поверхности](images\Ref18\DEM.png)


> Обратите внимание, что каждый слой для блока может быть представлен только в одном экземпляре. Если вы запускаете процедуру с новыми параметрами, то выходной слой перезапишется. Если вы хотите получить несколько вариантов одного слоя, необходимо сдублировать блок – нажать правой кнопкой мыши по блоку и выбрать **Duplicate** и указать те данные, которые необходимо сдублировать.




----
_Карпачевский А.М._ **Основы дистанционного зондирования и фотограмметрии**. М.: Географический факультет МГУ, `r lubridate::year(Sys.Date())`.
----