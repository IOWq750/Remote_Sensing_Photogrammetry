# Создание стереомодели и стереоизмерения в E-foto {#stereo}

## Установка программного обеспечения {#stereo-soft}
[В начало справки ⇡](#stereo)


Для практической работы вам понадобится открытая учебная фотограмметрическая программа **E-foto**. Информацию о ней можно найти на [домашнем сайте](http://www.efoto.eng.uerj.br/){target="_blank"}, там же можно скачать себе дистрибутив программы. Для этого перейдите во вкладку **DOWNLOAD – Latest Version**.


![Страница для загрузки программы и данных](images\Ref13\Download.png)


Запустите скачанный пакет установщика и установите программу.

## Исходные данные {#stereo-initial}
[В начало справки ⇡](#stereo)

В качестве исходных данных мы будем использовать серию аэрофотоснимков с перекрытием на территорию окрестностей УНС Сатино, сделанную в 1970 году, а также сеть опорных точек и топографическую карту.

[Снимки](https://yadi.sk/d/x7V_hMkPuviJVw){target="_blank"}

[Наземные опорные точки](https://yadi.sk/d/gEQC2jcCFJGifA){target="_blank"}

[Топографическая карта масштаба 1:10 000](https://yadi.sk/i/XM7Z30SZcvy6IA){target="_blank"}

## Создание проекта {#stereo-create_project}
[В начало справки ⇡](#stereo)

Запустите программу **E-foto**. В меню выберите **Project – New**. Укажите путь для сохранения файла проекта с расширением **.epp**.

Откроется окно менеджера проекта. Слева приведена структура проекта, а по центру - содержание. В разделе **Project Header** вам нужно указать общую информацию о проекте. Для этого включите режим редактирования, нажав на кнопку **Edit** внизу страницы.


![Окно менеджера проекта](images\Ref13\Project_Manager.png)


Перейдите в раздел **Terrain** и укажите общую информацию о территории.

_Максимальная высота_ – 200 м.

_Минимальная высота_ – 133 м.

_Средняя высота_ – 167 м.

_Зона UTM_ – 37.

Примерную широту и долготу центра территории укажите, используя программу **Google Earth** и точки фототриангуляции. Не забудьте указать правильные полушария.

Перейдите в раздел **Sensor** и укажите общую информацию о съёмке.

_Сенсор_ – АФА-41/10.

_Тип_ – кадровый аналоговый снимок.

_Калиброванное фокусное расстояние аэрофотоаппарата_ – 96.78 мм.

_Координаты главной точки_ – x = 0.5, y = 0.4.

Компенсированная радиальная дисторсия учтена при калибровке фокусного расстояния (исходно 100 мм). Некомпенсированная радиальная дисторсия +-25 мкм, что очень мало, поэтому мы ей можем пренебречь.

Укажите координаты координатных меток снимков (**Fiducial marks**) в последней таблице.

![Координаты меток](images\Ref13\Fiducial.png)


В разделе **Flight** мы можем указать примерную высоту съёмку – 1500 м, а также примерный масштаб снимков 1:14 000.

В разделе **images** нужно загрузить аэрофотоснимки, указав их разрешение – **2400 dpi**. Вы можете после этого открыть раздел с каждым из загруженных снимков и увидеть информацию о нём.

![Параметры снимка внутри проекта](images\Ref13\Image_Properties.png)


В этом разделе нажмите на кнопку **View Image** для просмотра изображения. Если при открытии изображения возникла ошибка, то, скорее всего, у вас неправильно записались пути в файле проекта. Обратите внимание на снимок экрана выше – в строке пути должен быть указан путь, в строке имени файла - только его имя, а в строке ID снимка достаточно указать имя файла без расширения. Исправить это внутри программы нельзя, но, к счастью, файл проекта – это документ XML, который редактируется блокнотом. Найдите внутри него соответствующие теги и исправьте содержимое внутри них.


![Параметры снимка в формате XML](images\Ref13\XML_editing.png)


## Внутреннее ориентирование {#stereo-interior}
[В начало справки ⇡](#stereo)

Для выполнения внутреннего ориентирования снимков выберите пункт меню **Execute – Interior Orientation**. В открывшемся окне предлагается выбрать снимок для ориентирования. Необходимо последовательно выполнить эту операцию для всех снимков. Для масштабирования можно использовать инструмент лупы, который работает на выделяемую прямоугольную область. Для произвольного изменения масштаба в обе стороны нужно зажать колёсико мыши. Координатные метки рассматриваемых снимков расположены возле края середины каждой из сторон и представляют собой асимметричные кресты, которые по размеру больше, чем обычные регулярные кресты, идущие с шагом в 1 см.


![Координатная метка снимка](images\Ref13\Mark.png)


Обратите внимание на порядок координатных меток – правая, левая, верхняя, нижняя. Вам нужно расставлять их в таком же порядке. Внизу окна приводится табличка, где выделена строка с активной на данной момент меткой. Как только вы метку установили, автоматически активной становится следующая метка в таблице. Если вам необходимо исправить положение координатной метки, то нужно выделить соответствующую строку в таблице и указать на снимке правильное положение метки.

После расстановки меток нажмите на кнопку ![](images\Ref13\Execute_IO.png). В результате откроется окно отчёта внутреннего ориентирования с вектором параметров аффинного преобразования системы координат камеры и матрицей вариации-ковариации. Если точность операции удовлетворительная, то будет активна кнопка **Accept**, нажав которую, мы сохраняем параметры. После этого нажмите на кнопку **Done** ![](images\Ref13\Done.png), что вернёт вас в основное окно проекта.


![Отчёт внутреннего ориентирования](images\Ref13\IO_Report.png)


Аналогично операция проделывается для всех снимков.


## Опорные точки {#stereo-GCP}
[В начало справки ⇡](#stereo)

Поскольку параметры внешнего ориентирования нам заранее неизвестны, то их необходимо рассчитать на основе обратной фотограмметрической засечки. Для этого нам потребуются опорные точки с известными координатами и высотами. Откройте в программе **Google Earth Pro** файл **KML** с точками фототриангуляции. Для просмотра нам потребуется снимок QuickBird за 20 апреля 2006 года (как самый хронологически близкий к 1970), который можно включить кнопкой ![](images\Ref13\Hystorical.png).


![Опорные точки на снимке QuickBird за 20 апреля 2006 года](images\Ref13\QB2006.png)


Следует иметь в виду, что координаты этих точек достаточно точно уравнены между собой, но снимок сам по себе может быть аффинно сдвинут на некую постоянную величину. Нам необходимо получить координаты этих точек в проекции UTM. Для переключения показа координат в UTM зайдите в меню **Инструменты – Настройки** и выберите соответствующий пункт в разделе **Показывать шир/долг**.


![Настройки показа координат](images\Ref13\GE_Settings.png)


Теперь, если вы правой кнопкой мыши щёлкните по опорной точке и из меню выберите **Свойства**, перед вами откроется окно с координатами восточного и северного склонения для точки.

Для добавления опорных точек в программе **E-foto** в меню проекта перейдите в раздел **Points** и нажмите на кнопку **New**. В открывшемся окне задайте имя опорной точки, впишите её координаты из **Google Earth**. Высоту точки возьмите с топографической карты, зная, что сечение основных горизонталей 2 метра. Для плановых координат указывается стандартное отклонение 3 метра (это худшее возможное значение согласно некоторым исследованиям [[1](https://www.researchgate.net/publication/332438341_Positional_Accuracy_Testing_of_Google_Earth){target="_blank"}, [2](https://www.tandfonline.com/doi/abs/10.3846/20296991.2017.1330767){target="_blank"}]). Для высот укажите СКО в 2 метра.

Опорная точка | Описание точки на АФС      
--------------|--------------------------------------------
p1            |`Северо-восточный угол сельского клуба в Сатино`            
p2            |`Северо-западный угол сатинского `~~`храма`~~` магазина`          
p3            |`Северо-западный угол пруда в Ивановском`            
p4            |`Угол леса в районе Бутовского холма`
p10           |`Северо-восточный угол забора садов в Рыжково` 
p11           |`Юго-восточный угол пристройки коровника в Загрязье`
p12           |`Юго-западный угол коровника в Ивановском`
p13           |`Внутренний угол забора садового участка в Сатино`
p14           |`Юго-восточный угол залежной полосы на склоне южнее урочища Вторые Столбцы`
p15           |`Северный угол островка леса на Дедюевском холма, соответствующий краю развилки дорог`
p16           |`Одиноко стоящее дерево в верховьях Антоновской балки`
p17           |`Юго-восточный угол пруда в Медвежьем болоте`
p18           |`Западный угол пожарного пруда в Рыжковской излучине`
p19           |`Поворот дороги вдоль юго-восточного угла леса`
p20           |`Северо-западный угол храма в Беницах`
p21           |`Угол забора в Рыжково`
p22           |`Верхушка оврага Узкого`
p23           |`Барсучий овраг`

Внесите информацию об опорных точках и сохраните проект.

## Обратная фотограмметрическая засечка {#stereo-resection}
[В начало справки ⇡](#stereo)

Для внешнего ориентирования с помощью обратной фотограмметрической засечки в меню выберите пункт **Execute – Spatial Resection**. Аналогично внутреннему ориентированию откроется окно с выбором снимка. Далее откроется снимок с таблицей опорных точек внизу. Аналогично расстановке координатных меток установите опорные точки на снимке с помощью кнопки **Measure** ![](images\Ref13\Measure.png). Пропускайте те точки, которые отсутствуют на данном снимке. Для исключения опорной точки из засечки нажмите на крестик ![](images\Ref13\Exclusion.png). После расстановки всех опорных точек на снимке нажмите на ![](images\Ref03\Execute_EO.png), согласитесь со всеми параметрами точности, после чего перед вами откроется отчёт об уравнивании с параметрами внешнего ориентирования и матрицей вариации-ковариации.


![Окно отчёта уравнивания параметров внешнего ориентирования](images\Ref13\EO_Report.png)


Обратите внимание, что значение координаты Z должно быть около 1600 м, значения углов должны быть маленькими. Если параметры точности в матрице достаточны, то вы сможете нажать на кнопку **Accept** – параметры внешнего ориентирования будут сохранены. После этого нажмите на кнопку **Done** ![](images\Ref13\Done.png), что вернёт вас в основное окно проекта. Проделайте аналогичные операции для остальных снимков.


## Взаимное ориентирование снимков {#stereo-phototriangulation}
[В начало справки ⇡](#stereo)

Ранее вы получили элементы внешнего ориентирования для каждого снимка по отдельности. Для более точного ориентирования модели местности необходимо взаимно ориентировать снимки и сделать уравнивание связок. В меню выберите пункт **Execute – Phototriangulation**.


![Окно стереокомпаратора](images\Ref13\Phototriangulation.png)


Перед вами откроются окна с левым и правым снимком, окно со списком наземных опорных точек, а также окна с их измерениями на соответственных снимках. Для фототриангуляции необходимо дополнительно поставить так называемые **фотограмметрические точки (связующие точки)**.


> Обратите внимание, что для корректных измерений и дальнейшего ориентирования модели необходимо правильно указать левый и правый снимок – они должны быть в соответствующих окнах.


Для создания связующей точки нажмите на кнопку **Create a photogrammetric point in project** ![](images\Ref13\Tie_Point.png). Затем разместите точку с помощью кнопки **Measure** на левом и правом снимке. При выборе места размещения помните о наилучших местах на стереопаре при взаимном ориентировании снимков.


После расстановки всех связующих точек на всех снимках нажмите на кнопку **Execute phototriangulation** ![](images\Ref13\Execute_EO.png). Откроется окно, где будут предложены снимки и точки для уравнивания связок проектирующих лучей.


![Окно выбора снимков и точек для фототриангуляции](images\Ref13\Phototriangulation_execution.png)


Если на предыдущих этапах всё было сделано правильно, то вы получите отчёт с корректными значениями элементов внешнего ориентирования, которые можно принять и использовать в дальнейшем. Помимо элементов внешнего ориентирования в отчёте приводятся поправки к ним относительно ранее выполненной обратной фотограмметрической засечки, а также расчётные координаты для связующих точек.


![Окно отчёта фототриангуляции](images\Ref13\Phototriangulation_report.png)


> Обратите внимание, что из-за особенностей программы координата северного склонения в отчёте получает дополнительный разряд в начале. К сожалению, в текущей версии эта проблема не решается и для дальнейшей работы необходимо иметь в виду, что у вас есть дополнительный сдвиг по оси Y на 10000000 м.


Если полученные результаты вас устраивают, нажмите на кнопку **Save measurements**.


## Работа в стереокомпараторе {#stereo-stereoplotter}
[В начало справки ⇡](#stereo)

В меню проекта выберите пункт **Execute – Stereo Plotter**. Откроется окно с анаглифными изображением стереопары снимков. Для эффективной работы с анаглифами рекомендуется использовать специальные очки.


![Окно стереокомпаратора](images\Ref13\Stereoplotter.png)


Если изображение в анаглифических очках двоится, зажмите **SHIFT** и подвиньте изображение до тех пор, пока рассматриваемый участок не сольётся в объёмное изображение. Для измерения высоты в точке нужно добавить точку с помощью кнопки ![](images\Ref13\Add_Point.png), далее выбрать кнопку ![](images\Ref13\Measure.png). При устранённых параллаксах (восстановленной стереомодели на данную территорию) с помощью колеса мыши нужно посадить марку на измеряемый объект. На увеличенных фрагментах левого и правого изображения снизу будут показываться эти марки в «монокулярном» режиме. Как только мнимая марка слилась (реальные марки оказались на соответственных точках), нажмите левую кнопку мыши и в окне справа появятся измерения для данной точки. В случае, если вы замечаете поперечный параллакс, необходимо зажать **CTRL** и крутить колесо мыши до тех пор, пока поперечный параллакс не станет равен нулю.

Результаты измерений можно экспортировать в виде текстового файла, нажав на кнопку ![](images\Ref13\Export.png).

----
_Карпачевский А.М._ **Основы дистанционного зондирования и фотограмметрии**. М.: Географический факультет МГУ, `r lubridate::year(Sys.Date())`.
----